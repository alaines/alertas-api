datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model WazeIncident {
  id             BigInt   @id @default(autoincrement())
  source         String   @default("waze")
  uuid           String   @unique
  type           String
  subtype        String?
  city           String?
  street         String?
  road_type      Int?
  magvar         Int?
  report_rating  Int?
  report_by_muni Boolean
  confidence     Int?
  reliability    Int?
  pub_millis     BigInt
  pub_time       DateTime @db.Timestamptz(6)
  category       String?
  priority       Int?
  status         String   @default("active")
  created_at     DateTime @db.Timestamptz(6) @default(now())
  updated_at     DateTime @db.Timestamptz(6) @default(now())

  @@map("waze_incidents")
}

model User {
  id         Int      @id @default(autoincrement())
  email      String   @unique
  username   String   @unique
  password   String
  fullName   String   @map("full_name")
  role       UserRole @default(VIEWER)
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  lastLogin  DateTime? @map("last_login") @db.Timestamptz(6)

  createdTickets   Ticket[]      @relation("CreatedTickets")
  assignedTickets  Ticket[]      @relation("AssignedTickets")
  ticketEvents     TicketEvent[]
  devices          Device[]
  deviceEvents     DeviceEvent[]

  @@map("users")
}

enum UserRole {
  ADMIN
  OPERATOR
  VIEWER
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  DONE
}

enum TicketEventType {
  CREATED
  COMMENT
  STATUS_CHANGED
  UPDATED
  ASSIGNED
  UNASSIGNED
}

enum TicketSource {
  WAZE
  PHONE_CALL
  WHATSAPP
  INSPECTORS
  OTHER
}

model Ticket {
  id                BigInt        @id @default(autoincrement())
  incidentId        BigInt?       @map("incident_id")
  incidentUuid      String?       @map("incident_uuid") @db.Uuid
  source            TicketSource  @default(OTHER)
  incidentType      String?       @map("incident_type")
  title             String
  description       String?       @db.Text
  status            TicketStatus  @default(OPEN)
  priority          Int?
  createdByUserId   Int           @map("created_by_user_id")
  assignedToUserId  Int?          @map("assigned_to_user_id")
  createdAt         DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime      @updatedAt @map("updated_at") @db.Timestamptz(6)

  createdBy         User          @relation("CreatedTickets", fields: [createdByUserId], references: [id])
  assignedTo        User?         @relation("AssignedTickets", fields: [assignedToUserId], references: [id])
  events            TicketEvent[]

  @@index([incidentId])
  @@index([incidentUuid])
  @@index([status])
  @@index([source])
  @@index([createdByUserId])
  @@index([assignedToUserId])
  @@map("tickets")
}

model TicketEvent {
  id                BigInt          @id @default(autoincrement())
  ticketId          BigInt          @map("ticket_id")
  eventType         TicketEventType @map("event_type")
  fromStatus        TicketStatus?   @map("from_status")
  toStatus          TicketStatus?   @map("to_status")
  message           String?         @db.Text
  payload           Json?           @db.JsonB
  createdByUserId   Int             @map("created_by_user_id")
  createdAt         DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)

  ticket            Ticket          @relation(fields: [ticketId], references: [id], onDelete: Restrict)
  createdBy         User            @relation(fields: [createdByUserId], references: [id])

  @@index([ticketId, createdAt])
  @@map("ticket_events")
}

enum DeviceType {
  CAMERA
  TRAFFIC_LIGHT
  SENSOR
  COUNTING_CAMERA
  OTHER
}

enum DeviceStatus {
  ACTIVE
  INACTIVE
  MAINTENANCE
  DAMAGED
}

model Device {
  id                    BigInt        @id @default(autoincrement())
  name                  String
  type                  DeviceType
  brand                 String?
  model                 String?
  serialNumber          String?       @unique @map("serial_number")
  installationYear      Int?          @map("installation_year")
  manufactureYear       Int?          @map("manufacture_year")
  latitude              Float?        @map("lat")
  longitude             Float?        @map("lon")
  address               String?
  ipAddress             String?       @map("ip_address")
  username              String?
  password              String?
  status                DeviceStatus  @default(ACTIVE)
  lastMaintenanceDate   DateTime?     @map("last_maintenance_date") @db.Timestamptz(6)
  notes                 String?       @db.Text
  createdByUserId       Int           @map("created_by_user_id")
  createdAt             DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt             DateTime      @updatedAt @map("updated_at") @db.Timestamptz(6)

  createdBy             User          @relation(fields: [createdByUserId], references: [id])
  events                DeviceEvent[]

  @@index([type])
  @@index([status])
  @@index([createdByUserId])
  @@map("devices")
}

enum DeviceEventType {
  CREATED
  UPDATED
  STATUS_CHANGED
  MAINTENANCE
  REPAIR
  CONFIGURATION_CHANGED
}

model DeviceEvent {
  id                BigInt            @id @default(autoincrement())
  deviceId          BigInt            @map("device_id")
  eventType         DeviceEventType   @map("event_type")
  fromStatus        DeviceStatus?     @map("from_status")
  toStatus          DeviceStatus?     @map("to_status")
  description       String?           @db.Text
  payload           Json?             @db.JsonB
  createdByUserId   Int               @map("created_by_user_id")
  createdAt         DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)

  device            Device            @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  createdBy         User              @relation(fields: [createdByUserId], references: [id])

  @@index([deviceId, createdAt])
  @@map("device_events")
}

model spatial_ref_sys {
  srid      Int     @id
  auth_name String?
  auth_srid Int?
  srtext    String?
  proj4text String?

  @@ignore
}
